<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BTT Auto Manager</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #1a1a1a;
            color: #e0e0e0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #2d2d2d;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #4a90e2 0%, #7b68ee 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        .header h1 {
            margin: 0;
            font-size: 2.5em;
        }
        .content {
            padding: 20px;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #404040;
            border-radius: 8px;
            background: #333333;
        }
        .section h2 {
            margin-top: 0;
            color: #e0e0e0;
            border-bottom: 2px solid #4a90e2;
            padding-bottom: 10px;
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .status-card {
            background: #404040;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #4a90e2;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .status-card h3 {
            margin: 0 0 10px 0;
            color: #e0e0e0;
        }
        .status-value {
            font-size: 1.2em;
            font-weight: bold;
        }
        .status-online { color: #4ade80; }
        .status-offline { color: #f87171; }
        .status-warning { color: #fbbf24; }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        .data-table th, .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #555;
        }
        .data-table th {
            background-color: #4a90e2;
            color: white;
        }
        .data-table tr:nth-child(even) {
            background-color: #404040;
        }
        .data-table tr:hover {
            background-color: #4a4a4a;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
        }
        .modal-content {
            background-color: #2d2d2d;
            margin: 5% auto;
            padding: 20px;
            border-radius: 10px;
            width: 80%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            color: #e0e0e0;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #555;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        .modal-title {
            font-size: 1.5em;
            font-weight: bold;
            color: #e0e0e0;
        }
        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover {
            color: #e0e0e0;
        }
        .command-output {
            background: #1a1a1a;
            border: 1px solid #555;
            border-radius: 5px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            margin: 10px 0;
            color: #e0e0e0;
        }
        .device-name {
            font-weight: bold;
            color: #e0e0e0;
        }
        .device-name-input {
            width: 100%;
            padding: 5px;
            border: 1px solid #555;
            border-radius: 3px;
            font-size: 14px;
            background: #404040;
            color: #e0e0e0;
        }
        .edit-name-btn {
            background: #0ea5e9;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 5px;
        }
        .edit-name-btn:hover {
            background: #0284c7;
        }
        .save-name-btn {
            background: #22c55e;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 5px;
        }
        .save-name-btn:hover {
            background: #16a34a;
        }
        .button {
            background: #4a90e2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .button:hover {
            background: #3b82f6;
        }
        .button.danger {
            background: #ef4444;
        }
        .button.danger:hover {
            background: #dc2626;
        }
        .button.success {
            background: #22c55e;
        }
        .button.success:hover {
            background: #16a34a;
        }
        .button.warning {
            background: #fbbf24;
            color: #1f2937;
        }
        .button.warning:hover {
            background: #f59e0b;
        }
        .input-group {
            margin: 10px 0;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #e0e0e0;
        }
        .input-group input, .input-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #555;
            border-radius: 4px;
            box-sizing: border-box;
            background: #404040;
            color: #e0e0e0;
        }
        .refresh-btn {
            float: right;
            background: #22c55e;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
        }
        .refresh-btn:hover {
            background: #16a34a;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #9ca3af;
        }
        .error {
            color: #f87171;
            background: #450a0a;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border: 1px solid #dc2626;
        }
        .success {
            color: #4ade80;
            background: #064e3b;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border: 1px solid #16a34a;
        }
        .warning {
            color: #fbbf24;
            background: #451a03;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border: 1px solid #f59e0b;
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #555;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: #e0e0e0;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #22c55e;
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        .connection-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .connection-connected {
            background: #064e3b;
            color: #4ade80;
            border: 1px solid #16a34a;
        }
        .connection-disconnected {
            background: #450a0a;
            color: #f87171;
            border: 1px solid #dc2626;
        }
        .connection-testing {
            background: #451a03;
            color: #fbbf24;
            border: 1px solid #f59e0b;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöõ BTT Auto Manager</h1>
            <p>SQL Database Extraction & ADB Management</p>
        </div>
        
        <div class="content">
            <!-- Status Section -->
            <div class="section">
                <h2>üìä System Status <button class="refresh-btn" onclick="refreshStatus()">üîÑ Refresh</button></h2>
                <div id="status-content" class="loading">Loading status...</div>
            </div>

            <!-- SQL Data Section -->
            <div class="section">
                <h2>üóÑÔ∏è SQL Database Data <button class="refresh-btn" onclick="refreshSQLData()">üîÑ Refresh</button></h2>
                <div id="sql-content" class="loading">Loading SQL data...</div>
            </div>

            <!-- ADB IP Management Section -->
            <div class="section">
                <h2>üì± ADB Device Management <button class="refresh-btn" onclick="refreshADBIPs()">üîÑ Refresh</button></h2>
                <div id="adb-content" class="loading">Loading ADB IPs...</div>
                
                <div class="input-group">
                    <label for="new-ip">Add New ADB IP:</label>
                    <input type="text" id="new-ip" placeholder="192.168.1.100:5555" />
                    <button class="button success" onclick="addADBIP()">Add IP</button>
                </div>
            </div>

            <!-- Control Section -->
            <div class="section">
                <h2>‚öôÔ∏è System Controls</h2>
                <div id="control-content">
                    <div class="status-card">
                        <h3>Auto-Update Settings</h3>
                        <div class="input-group">
                            <label>Auto-Update Status:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="auto-update-toggle" onchange="toggleAutoUpdate()">
                                    <span class="slider"></span>
                                </label>
                                <span id="auto-update-status">Loading...</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label for="update-interval">Update Interval (minutes):</label>
                            <input type="number" id="update-interval" min="1" max="1440" value="5" />
                            <button class="button" onclick="setUpdateInterval()">Set Interval</button>
                        </div>
                    </div>
                    
                    <div class="status-card">
                        <h3>Manual Controls</h3>
                        <button class="button" onclick="runExtraction()">Run Extraction Now</button>
                        <button class="button" onclick="updateStatus()">Update Status</button>
                    </div>
                </div>
                <div id="control-result"></div>
            </div>
        </div>
    </div>

    <!-- Modal for ADB Command Output -->
    <div id="adbModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">ADB Connection Test Results</div>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div id="modalContent">
                <div id="commandOutput" class="command-output"></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        
        // Utility functions
        async function apiCall(endpoint, method = 'GET', data = null) {
            try {
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                };
                
                if (data) {
                    options.body = JSON.stringify(data);
                }
                
                const response = await fetch(`${API_BASE}${endpoint}`, options);
                return await response.json();
            } catch (error) {
                console.error('API call failed:', error);
                return { error: error.message };
            }
        }

        function showMessage(elementId, message, type = 'success') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="${type}">${message}</div>`;
            setTimeout(() => {
                element.innerHTML = '';
            }, 5000);
        }

        // Status functions
        async function refreshStatus() {
            const statusDiv = document.getElementById('status-content');
            statusDiv.innerHTML = '<div class="loading">Loading status...</div>';
            
            try {
                const status = await apiCall('/status');
                if (status.error) {
                    statusDiv.innerHTML = `<div class="error">Error loading status: ${status.error}</div>`;
                    return;
                }
                
                const html = `
                    <div class="status-grid">
                        <div class="status-card">
                            <h3>Auto-Update Status</h3>
                            <div class="status-value ${status.autoEnabled ? 'status-online' : 'status-offline'}">
                                ${status.autoEnabled ? 'üü¢ Enabled' : 'üî¥ Disabled'}
                            </div>
                        </div>
                        <div class="status-card">
                            <h3>Webhook Server</h3>
                            <div class="status-value status-online">üü¢ Running</div>
                        </div>
                        <div class="status-card">
                            <h3>Update Interval</h3>
                            <div class="status-value">${status.intervalMinutes || 5} minutes</div>
                        </div>
                        <div class="status-card">
                            <h3>Server Uptime</h3>
                            <div class="status-value">${Math.round(status.uptime || 0)} seconds</div>
                        </div>
                    </div>
                    <div class="status-card">
                        <h3>Database Statistics</h3>
                        <table class="data-table">
                            <tr>
                                <th>Metric</th>
                                <th>Value</th>
                                <th>Last Updated</th>
                            </tr>
                            <tr>
                                <td>Locations</td>
                                <td>${status.lastLocations || 0}</td>
                                <td>${status.lastProcessed || 'Never'}</td>
                            </tr>
                            <tr>
                                <td>Cars</td>
                                <td>${status.lastCars || 0}</td>
                                <td>${status.lastProcessed || 'Never'}</td>
                            </tr>
                            <tr>
                                <td>Loads</td>
                                <td>${status.lastLoads || 0}</td>
                                <td>${status.lastProcessed || 'Never'}</td>
                            </tr>
                        </table>
                    </div>
                `;
                statusDiv.innerHTML = html;
                
                // Update the toggle switch and interval input
                updateControlElements(status);
                
            } catch (error) {
                statusDiv.innerHTML = `<div class="error">Error loading status: ${error.message}</div>`;
            }
        }

        function updateControlElements(status) {
            // Update toggle switch
            const toggle = document.getElementById('auto-update-toggle');
            const statusText = document.getElementById('auto-update-status');
            if (toggle && statusText) {
                toggle.checked = status.autoEnabled || false;
                statusText.textContent = status.autoEnabled ? 'Enabled' : 'Disabled';
            }
            
            // Update interval input
            const intervalInput = document.getElementById('update-interval');
            if (intervalInput) {
                intervalInput.value = status.intervalMinutes || 5;
            }
        }

        // SQL Data functions
        async function refreshSQLData() {
            const sqlDiv = document.getElementById('sql-content');
            sqlDiv.innerHTML = '<div class="loading">Loading SQL data...</div>';
            
            try {
                const [dwjjob, dwvveh, loadNumbers] = await Promise.all([
                    apiCall('/webhook/dwjjob'),
                    apiCall('/webhook/dwvveh'),
                    apiCall('/webhook/load-numbers')
                ]);
                
                let html = '<div class="status-grid">';
                
                // DWJJOB Data
                if (dwjjob.error) {
                    html += `<div class="status-card"><h3>DWJJOB Data</h3><div class="error">Error: ${dwjjob.error}</div></div>`;
                } else {
                    html += `
                        <div class="status-card">
                            <h3>DWJJOB Data (${dwjjob.length || 0} records)</h3>
                            <div class="status-value">${dwjjob.length || 0} locations</div>
                            ${dwjjob.length > 0 ? `<button class="button" onclick="showDWJJOBData()">View Details</button>` : ''}
                        </div>
                    `;
                }
                
                // DWVVEH Data
                if (dwvveh.error) {
                    html += `<div class="status-card"><h3>DWVVEH Data</h3><div class="error">Error: ${dwvveh.error}</div></div>`;
                } else {
                    html += `
                        <div class="status-card">
                            <h3>DWVVEH Data (${dwvveh.length || 0} records)</h3>
                            <div class="status-value">${dwvveh.length || 0} vehicles</div>
                            ${dwvveh.length > 0 ? `<button class="button" onclick="showDWVVEHData()">View Details</button>` : ''}
                        </div>
                    `;
                }
                
                // Load Numbers Data
                if (loadNumbers.error) {
                    html += `<div class="status-card"><h3>Load Numbers</h3><div class="error">Error: ${loadNumbers.error}</div></div>`;
                } else {
                    html += `
                        <div class="status-card">
                            <h3>Load Numbers (${loadNumbers.totalLoads || 0} unique)</h3>
                            <div class="status-value">${loadNumbers.totalRecords || 0} total records</div>
                            ${loadNumbers.totalLoads > 0 ? `<button class="button" onclick="showLoadNumbersData()">View Details</button>` : ''}
                        </div>
                    `;
                }
                
                html += '</div>';
                sqlDiv.innerHTML = html;
                
                // Store data for detail views
                window.dwjjobData = dwjjob;
                window.dwvvehData = dwvveh;
                window.loadNumbersData = loadNumbers;
                
            } catch (error) {
                sqlDiv.innerHTML = `<div class="error">Error loading SQL data: ${error.message}</div>`;
            }
        }

        function showDWJJOBData() {
            if (!window.dwjjobData || window.dwjjobData.length === 0) {
                alert('No DWJJOB data available');
                return;
            }
            
            const data = window.dwjjobData.slice(0, 10); // Show first 10 records
            let html = '<h3>DWJJOB Data (First 10 records)</h3><table class="data-table"><thead><tr>';
            
            // Create headers from first record
            if (data.length > 0) {
                Object.keys(data[0]).forEach(key => {
                    html += `<th>${key}</th>`;
                });
                html += '</tr></thead><tbody>';
                
                data.forEach(record => {
                    html += '<tr>';
                    Object.values(record).forEach(value => {
                        html += `<td>${value || ''}</td>`;
                    });
                    html += '</tr>';
                });
                html += '</tbody></table>';
            }
            
            document.getElementById('sql-content').innerHTML = html + '<button class="button" onclick="refreshSQLData()">‚Üê Back to Summary</button>';
        }

        function showDWVVEHData() {
            if (!window.dwvvehData || window.dwvvehData.length === 0) {
                alert('No DWVVEH data available');
                return;
            }
            
            const data = window.dwvvehData.slice(0, 10); // Show first 10 records
            let html = '<h3>DWVVEH Data (First 10 records)</h3><table class="data-table"><thead><tr>';
            
            // Create headers from first record
            if (data.length > 0) {
                Object.keys(data[0]).forEach(key => {
                    html += `<th>${key}</th>`;
                });
                html += '</tr></thead><tbody>';
                
                data.forEach(record => {
                    html += '<tr>';
                    Object.values(record).forEach(value => {
                        html += `<td>${value || ''}</td>`;
                    });
                    html += '</tr>';
                });
                html += '</tbody></table>';
            }
            
            document.getElementById('sql-content').innerHTML = html + '<button class="button" onclick="refreshSQLData()">‚Üê Back to Summary</button>';
        }

        function showLoadNumbersData() {
            if (!window.loadNumbersData || !window.loadNumbersData.loadNumbers || window.loadNumbersData.loadNumbers.length === 0) {
                alert('No load numbers data available');
                return;
            }
            
            const data = window.loadNumbersData.loadNumbers;
            let html = '<h3>Load Numbers Data</h3>';
            html += `<p><strong>Total Unique Loads:</strong> ${window.loadNumbersData.totalLoads || 0}</p>`;
            html += `<p><strong>Total Records:</strong> ${window.loadNumbersData.totalRecords || 0}</p>`;
            html += '<table class="data-table"><thead><tr><th>Load Number</th><th>Record Count</th></tr></thead><tbody>';
            
            data.forEach(load => {
                html += `<tr><td>${load.loadNumber}</td><td>${load.count}</td></tr>`;
            });
            
            html += '</tbody></table>';
            document.getElementById('sql-content').innerHTML = html + '<button class="button" onclick="refreshSQLData()">‚Üê Back to Summary</button>';
        }

        // ADB IP Management functions
        async function refreshADBIPs() {
            const adbDiv = document.getElementById('adb-content');
            adbDiv.innerHTML = '<div class="loading">Loading ADB IPs...</div>';
            
            try {
                const ips = await apiCall('/webhook/adb-ips');
                if (ips.error) {
                    adbDiv.innerHTML = `<div class="error">Error loading ADB IPs: ${ips.error}</div>`;
                    return;
                }
                
                let html = '<div class="status-card">';
                html += '<h3>Configured ADB IP Addresses</h3>';
                
                if (!Array.isArray(ips) || ips.length === 0) {
                    html += '<p>No ADB IP addresses configured</p>';
                } else {
                    html += '<table class="data-table"><thead><tr><th>Device Name</th><th>IP Address</th><th>Connection Status</th><th>Test Result</th><th>Actions</th></tr></thead><tbody>';
                    ips.forEach(entry => {
                        const ip = entry.ip || entry;
                        const connected = entry.connected === true;
                        const name = entry.name || 'Unnamed Device';
                        const nameId = `name-${ip.replace(/[.:]/g, '-')}`;
                        const nameInputId = `name-input-${ip.replace(/[.:]/g, '-')}`;
                        html += `
                            <tr>
                                <td>
                                    <span class="device-name" id="${nameId}">${name}</span>
                                    <input type="text" class="device-name-input" id="${nameInputId}" value="${name}" style="display: none;">
                                    <button class="edit-name-btn" onclick="editDeviceName('${ip}', '${nameId}', '${nameInputId}')">Edit</button>
                                    <button class="save-name-btn" onclick="saveDeviceName('${ip}', '${nameId}', '${nameInputId}')" style="display: none;">Save</button>
                                </td>
                                <td>${ip}</td>
                                <td><span class="connection-status ${connected ? 'connection-connected' : 'connection-disconnected'}" id="status-${ip.replace(/[.:]/g, '-')}">${connected ? 'Connected' : 'Disconnected'}</span></td>
                                <td><span id="test-${ip.replace(/[.:]/g, '-')}">${connected ? 'PASS' : 'FAIL'}</span></td>
                                <td>
                                    <button class="button danger" onclick="removeADBIP('${ip}')">Remove</button>
                                    <button class="button warning" onclick="testConnection('${ip}')">Test</button>
                                </td>
                            </tr>
                        `;
                    });
                    html += '</tbody></table>';
                }
                html += '</div>';
                adbDiv.innerHTML = html;
            } catch (error) {
                adbDiv.innerHTML = `<div class="error">Error loading ADB IPs: ${error.message}</div>`;
            }
        }

        async function addADBIP() {
            const ip = document.getElementById('new-ip').value.trim();
            if (!ip) {
                showMessage('control-result', 'Please enter an IP address', 'error');
                return;
            }
            
            const result = await apiCall('/webhook/adb-ips', 'POST', {
                action: 'add',
                ip: ip
            });
            
            if (result.error) {
                showMessage('control-result', `Error adding IP: ${result.error}`, 'error');
            } else {
                showMessage('control-result', `Successfully added IP: ${ip}`, 'success');
                document.getElementById('new-ip').value = '';
                refreshADBIPs();
            }
        }

        async function removeADBIP(ip) {
            if (!confirm(`Are you sure you want to remove ${ip}?`)) {
                return;
            }
            
            const result = await apiCall('/webhook/adb-ips', 'POST', {
                action: 'remove',
                ip: ip
            });
            
            if (result.error) {
                showMessage('control-result', `Error removing IP: ${result.error}`, 'error');
            } else {
                showMessage('control-result', `Successfully removed IP: ${ip}`, 'success');
                refreshADBIPs();
            }
        }

        async function testConnection(ip) {
            const statusElement = document.getElementById(`status-${ip.replace(/[.:]/g, '-')}`);
            const testElement = document.getElementById(`test-${ip.replace(/[.:]/g, '-')}`);
            
            if (statusElement) {
                statusElement.textContent = 'Testing...';
                statusElement.className = 'connection-status connection-testing';
            }
            
            if (testElement) {
                testElement.textContent = 'Testing...';
                testElement.style.color = '#ffc107';
            }
            
            try {
                // Test connection by trying to connect via ADB
                const result = await apiCall('/webhook/test-connection', 'POST', {
                    ip: ip
                });
                
                let output = `Testing ADB connection to ${ip}...\n\n`;
                
                if (result.error) {
                    output += `‚ùå Connection failed: ${result.error}\n`;
                    if (result.commandOutput) {
                        output += `\nCommand Output:\n${result.commandOutput}`;
                    }
                    
                    if (statusElement) {
                        statusElement.textContent = 'Failed';
                        statusElement.className = 'connection-status connection-disconnected';
                    }
                    if (testElement) {
                        testElement.textContent = 'FAIL';
                        testElement.style.color = '#dc3545';
                    }
                } else {
                    output += `‚úÖ Connection ${result.connected ? 'SUCCESSFUL' : 'FAILED'}\n`;
                    if (result.commandOutput) {
                        output += `\nCommand Output:\n${result.commandOutput}`;
                    }
                    
                    if (statusElement) {
                        statusElement.textContent = result.connected ? 'Connected' : 'Disconnected';
                        statusElement.className = result.connected ? 'connection-status connection-connected' : 'connection-status connection-disconnected';
                    }
                    if (testElement) {
                        testElement.textContent = result.connected ? 'PASS' : 'FAIL';
                        testElement.style.color = result.connected ? '#28a745' : '#dc3545';
                    }
                }
                
                // Show modal with command output
                showModal(output);
                
            } catch (error) {
                const output = `‚ùå Error testing connection to ${ip}:\n${error.message}`;
                showModal(output);
                
                if (statusElement) {
                    statusElement.textContent = 'Error';
                    statusElement.className = 'connection-status connection-disconnected';
                }
                if (testElement) {
                    testElement.textContent = 'ERROR';
                    testElement.style.color = '#dc3545';
                }
            }
        }

        // Modal Management Functions
        function showModal(content) {
            const modal = document.getElementById('adbModal');
            const outputDiv = document.getElementById('commandOutput');
            if (modal && outputDiv) {
                outputDiv.textContent = content;
                modal.style.display = 'block';
            }
        }

        function closeModal() {
            const modal = document.getElementById('adbModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Close modal when clicking outside of it
        window.onclick = function(event) {
            const modal = document.getElementById('adbModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // Control functions
        async function toggleAutoUpdate() {
            const toggle = document.getElementById('auto-update-toggle');
            const statusText = document.getElementById('auto-update-status');
            
            // Show loading state
            statusText.textContent = 'Updating...';
            
            const result = await apiCall('/webhook/control', 'POST', {
                action: 'toggle_auto'
            });
            
            if (result.error) {
                showMessage('control-result', `Error: ${result.error}`, 'error');
                // Revert toggle
                toggle.checked = !toggle.checked;
                statusText.textContent = toggle.checked ? 'Enabled' : 'Disabled';
            } else {
                showMessage('control-result', 'Auto-update toggled successfully', 'success');
                statusText.textContent = toggle.checked ? 'Enabled' : 'Disabled';
                refreshStatus();
            }
        }

        async function setUpdateInterval() {
            const intervalInput = document.getElementById('update-interval');
            const minutes = parseInt(intervalInput.value);
            
            if (isNaN(minutes) || minutes < 1 || minutes > 1440) {
                showMessage('control-result', 'Please enter a valid interval between 1 and 1440 minutes', 'error');
                return;
            }
            
            const result = await apiCall('/webhook/control', 'POST', {
                action: 'set_interval',
                minutes: minutes
            });
            
            if (result.error) {
                showMessage('control-result', `Error: ${result.error}`, 'error');
            } else {
                showMessage('control-result', `Update interval set to ${minutes} minutes`, 'success');
                refreshStatus();
            }
        }

        async function runExtraction() {
            const result = await apiCall('/webhook/control', 'POST', {
                action: 'run_extraction'
            });
            
            if (result.error) {
                showMessage('control-result', `Error: ${result.error}`, 'error');
            } else {
                showMessage('control-result', 'SQL extraction started', 'success');
                setTimeout(() => {
                    refreshStatus();
                    refreshSQLData();
                }, 5000);
            }
        }

        async function updateStatus() {
            const result = await apiCall('/webhook/control', 'POST', {
                action: 'update_status'
            });
            
            if (result.error) {
                showMessage('control-result', `Error: ${result.error}`, 'error');
            } else {
                showMessage('control-result', 'Status updated successfully', 'success');
                refreshStatus();
            }
        }

        // Initialize page
        window.onload = function() {
            refreshStatus();
            refreshSQLData();
            refreshADBIPs();
            
            // Auto-refresh status every 30 seconds without flashing
            setInterval(() => {
                // Only refresh status data, not the entire page
                fetchStatusSilently();
            }, 30000);
        };
        
        // Silent status refresh that doesn't cause visual flashing
        async function fetchStatusSilently() {
            try {
                const status = await apiCall('/status');
                if (!status.error) {
                    // Update status elements without full page refresh
                    updateStatusElements(status);
                }
            } catch (error) {
                console.error('Silent status refresh failed:', error);
            }
        }
        
        function updateStatusElements(status) {
            // Update status cards without full refresh
            const autoUpdateElement = document.querySelector('.status-card .status-value.status-online, .status-card .status-value.status-offline');
            if (autoUpdateElement) {
                autoUpdateElement.textContent = status.autoEnabled ? 'üü¢ Enabled' : 'üî¥ Disabled';
                autoUpdateElement.className = `status-value ${status.autoEnabled ? 'status-online' : 'status-offline'}`;
            }
            
            const intervalElement = document.querySelector('.status-card .status-value');
            if (intervalElement && intervalElement.previousElementSibling && intervalElement.previousElementSibling.textContent.includes('Update Interval')) {
                intervalElement.textContent = `${status.intervalMinutes || 5} minutes`;
            }
            
            const uptimeElement = document.querySelector('.status-card .status-value');
            if (uptimeElement && uptimeElement.previousElementSibling && uptimeElement.previousElementSibling.textContent.includes('Server Uptime')) {
                uptimeElement.textContent = `${Math.round(status.uptime || 0)} seconds`;
            }
            
            // Update database statistics
            const locationsElement = document.querySelector('td:contains("Locations") + td');
            if (locationsElement) {
                locationsElement.textContent = status.lastLocations || 0;
            }
            
            const carsElement = document.querySelector('td:contains("Cars") + td');
            if (carsElement) {
                carsElement.textContent = status.lastCars || 0;
            }
            
            const loadsElement = document.querySelector('td:contains("Loads") + td');
            if (loadsElement) {
                loadsElement.textContent = status.lastLoads || 0;
            }
        }

        // Device Name Management Functions
        function editDeviceName(ip, nameSpanId, nameInputId) {
            const nameSpan = document.getElementById(nameSpanId);
            const nameInput = document.getElementById(nameInputId);
            if (nameSpan && nameInput) {
                nameSpan.style.display = 'none';
                nameInput.style.display = 'inline-block';
                nameInput.focus();
                nameInput.setSelectionRange(0, nameInput.value.length); // Select text
            }
        }

        async function saveDeviceName(ip, nameSpanId, nameInputId) {
            const nameSpan = document.getElementById(nameSpanId);
            const nameInput = document.getElementById(nameInputId);
            const newName = nameInput.value.trim();

            if (!newName) {
                showMessage('control-result', 'Device name cannot be empty', 'error');
                return;
            }

            const result = await apiCall('/webhook/adb-ips', 'POST', {
                action: 'rename',
                ip: ip,
                name: newName
            });

            if (result.error) {
                showMessage('control-result', `Error renaming device: ${result.error}`, 'error');
            } else {
                showMessage('control-result', `Successfully renamed device to: ${newName}`, 'success');
                refreshADBIPs();
            }
            // Revert to original name
            nameSpan.textContent = newName;
            nameSpan.style.display = 'inline-block';
            nameInput.style.display = 'none';
        }

    </script>
</body>
</html> 